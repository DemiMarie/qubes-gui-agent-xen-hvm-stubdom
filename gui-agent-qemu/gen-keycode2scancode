#!/usr/bin/env python3

import sys

table_name = 'keycode2scancode'
if len(sys.argv) > 1:
    table_name = sys.argv[1]

# from linux/linux/drivers/input/keyboard/atkbd.c

atkbd_set2_keycode = [
      0, 67, 65, 63, 61, 59, 60, 88,  0, 68, 66, 64, 62, 15, 41,117,
      0, 56, 42, 93, 29, 16,  2,  0,  0,  0, 44, 31, 30, 17,  3,  0,
      0, 46, 45, 32, 18,  5,  4, 95,  0, 57, 47, 33, 20, 19,  6,183,
      0, 49, 48, 35, 34, 21,  7,184,  0,  0, 50, 36, 22,  8,  9,185,
      0, 51, 37, 23, 24, 11, 10,  0,  0, 52, 53, 38, 39, 25, 12,  0,
      0, 89, 40,  0, 26, 13,  0,  0, 58, 54, 28, 27,  0, 43,  0, 85,
      0, 86, 91, 90, 92,  0, 14, 94,  0, 79,124, 75, 71,121,  0,  0,
     82, 83, 80, 76, 77, 72,  1, 69, 87, 78, 81, 74, 55, 73, 70, 99,

      0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
    217,100,255,  0, 97,165,  0,  0,156,  0,  0,  0,  0,  0,  0,125,
    173,114,  0,113,  0,  0,  0,126,128,  0,  0,140,  0,  0,  0,127,
    159,  0,115,  0,164,  0,  0,116,158,  0,172,166,  0,  0,  0,142,
    157,  0,  0,  0,  0,  0,  0,  0,155,  0, 98,  0,  0,163,  0,  0,
    226,  0,  0,  0,  0,  0,  0,  0,  0,255, 96,  0,  0,  0,143,  0,
      0,  0,  0,  0,  0,  0,  0,  0,  0,107,  0,105,102,  0,  0,112,
    110,111,108,112,106,103,  0,119,  0,118,109,  0, 99,104,119,  0,

      0,  0,  0, 65, 99]

atkbd_unxlate_table = [
          0,118, 22, 30, 38, 37, 46, 54, 61, 62, 70, 69, 78, 85,102, 13,
         21, 29, 36, 45, 44, 53, 60, 67, 68, 77, 84, 91, 90, 20, 28, 27,
         35, 43, 52, 51, 59, 66, 75, 76, 82, 14, 18, 93, 26, 34, 33, 42,
         50, 49, 58, 65, 73, 74, 89,124, 17, 41, 88,  5,  6,  4, 12,  3,
         11,  2, 10,  1,  9,119,126,108,117,125,123,107,115,116,121,105,
        114,122,112,113,127, 96, 97,120,  7, 15, 23, 31, 39, 47, 55, 63,
         71, 79, 86, 94,  8, 16, 24, 32, 40, 48, 56, 64, 72, 80, 87,111,
         19, 25, 57, 81, 83, 92, 95, 98, 99,100,101,103,104,106,109,110]

# This reverses the scancode -> keycode mapping from atkbd_set_keycode_table()
# for the "translated" mode. The resulting scancodes are in the form as
# expected by qemu_input_key_value_to_scancode(). See linux and qemu source for
# details:
#  - linux/linux/drivers/input/keyboard/atkbd.c
#  - qemu/ui/input-keymap.c
#  - qemu/hw/input/ps2.c (especially ps2_put_keycode())

set2_rmap = {}
for j in range(len(atkbd_set2_keycode)):
    k = atkbd_set2_keycode[j]
    if k != 0 and k not in set2_rmap:
        set2_rmap[k] = j

uxl_rmap = {}
for i in range(len(atkbd_unxlate_table)):
    j = atkbd_unxlate_table[i]
    uxl_rmap[j] = i

keycodes = set(set2_rmap.keys())
k_map = {}
for k in keycodes:
    esc = False
    j = set2_rmap[k]
    if j >= 0x80:
        j &= 0x7f
        esc = True
    if j not in uxl_rmap:
        continue
    i = uxl_rmap[j]
    if esc:
        i |= 0x80
    k_map[k] = i

print("""\
// Autogenerated by ./gen-keycode2scancode {name}

#include <stdint.h>

uint8_t {name}[256] = {{\
""".format(name=table_name))

# X evdev keycodes have an offset of 8
for k in range(256):
    print("/* {0:3} */ 0x{1:02x},".format(k, k_map.get(k - 8, 0)))

print("""\
};\
""")
